---
title: "ST 558 Project 1"
author: "Jessica Speer"
date: "June 11, 2020"
output: 
  rmarkdown::github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("httr")
library("jsonlite")
library("tidyverse")
library("tidyr")
library("dplyr")
library("stringi")
library("DT")
library("ggplot2")
```


# JSON overview

# Reading JSON Data into R

# Function to Return Parsed Data from NHL API

The function that is generated below enables the user to pull several data sets from the NHL API.

**Usage:**

`getNHL(dataset, franchiseID)`

**Arguments:**

`dataset`: Enter `"franchise"`, `"teamtotals"`, `"seasonrecs"`, `"goalierecs"`, or `"skaterrecs"`

`franchiseID`: Valid Franchise ID required for `"seasonrecs"`, `"goalierecs"`, and `"skaterrecs"`

**Datasets:**

`"franchise"`: Returns id, firstSeasonId and lastSeasonId and name of every team in the history of the NHL

`"teamtotals"`: Returns total stats for every franchise (ex roadTies, roadWins, etc)

`"seasonrecs"`: Drill-down into season records for a specific franchise

`"goalierecs"`: Goalie records for the specified franchise

`"skaterrecs"`: (Skater records, same interaction as goalie endpoint

**Function generation:**

```{r, echo=TRUE, message=FALSE}
getNHL <- function(str1=NULL, id=NULL) {
  if (is.null(str1)){
    return("Please enter desired data and Franchise ID (if applicable)")
  } 
  else
  s1<-stri_compare(str1, "franchise")
  if (s1==0){
    f<-GET("https://records.nhl.com/site/api/franchise")
    f<-content(f, "text")
    f<-fromJSON(f,flatten=TRUE)
    f<-data.frame(f)
    f<-tbl_df(f)
    f <- f %>% select(data.id, data.firstSeasonId, data.lastSeasonId, data.teamCommonName)
    return(f)
  }
  else
  s2<-stri_compare(str1, "teamtotals")
  if (s2==0){
    f<-GET("https://records.nhl.com/site/api/franchise-team-totals")
    f<-content(f, "text")
    f<-fromJSON(f,flatten=TRUE)
    f<-data.frame(f)
    f<-tbl_df(f)
    return(f)
  }
  else
  s3<-stri_compare(str1, "seasonrecs")
  s4<-stri_compare(str1, "goalierecs")
  s5<-stri_compare(str1, "skaterrecs")
  if ((s3==0 | s4==0 | s5==0) & is.null(id)){
    return("Please enter a Franchise ID in the second argument.")
  }
  else
  `%notin%` <- Negate(`%in%`)
  if ((s3==0 | s4==0 | s5==0) & id %notin% 1:38){
    return("Franchise ID not recognized.")
  }  
  else
  if (s3==0 & id %in% 1:38){
    f<-GET(paste0("https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId=", id))
    f<-content(f, "text")
    f<-fromJSON(f,flatten=TRUE)
    f<-data.frame(f)
    f<-tbl_df(f)
    return(f)
  }
  else
  if (s4==0 & id %in% 1:38){
    f<-GET(paste0("https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId=", id))
    f<-content(f, "text")
    f<-fromJSON(f,flatten=TRUE)
    f<-data.frame(f)
    f<-tbl_df(f)
    return(f)
  }
  else
  if (s5==0 & id %in% 1:38){
    f<-GET(paste0("https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId=", id))
    f<-content(f, "text")
    f<-fromJSON(f,flatten=TRUE)
    f<-data.frame(f)
    f<-tbl_df(f)
    return(f)
  }  
}

```

## Using the Function

The function can be used to call several NHL data sets from the API. Examples are illustrated below.

```{r, echo=TRUE, message=FALSE}
#Call Franchise data, select variables
getNHL("franchise") %>% select(data.firstSeasonId, data.teamCommonName) %>% head(n=10)
```

```{r, echo=TRUE, message=FALSE}
#Call Team Totals data, select variables
getNHL("teamtotals") %>% select(data.teamName, data.homeWins) %>% head(n=10)
```

```{r, echo=TRUE, message=FALSE}
#Call Season Records data, select variables
getNHL("seasonrecs", 38) %>% select(data.franchiseName, data.homeWinStreak)
```

```{r, echo=TRUE, message=FALSE}
#Call Goalie Records data, select variables
getNHL("goalierecs", 38) %>% select(data.firstName, data.lastName, data.wins)
```

```{r, echo=TRUE, message=FALSE}
#Call Skater Records data, select variables
getNHL("skaterrecs", 38) %>% select(data.firstName, data.lastName, data.points) %>% head(n=10)
```

# Explore the NHL Data

```{r, echo=TRUE, message=FALSE}
t<-getNHL("teamtotals")
t<-t[t$data.gameTypeId==2,]
t$WinRatio<-t$data.wins/t$data.gamesPlayed
avgWins<-mean(t$WinRatio)
t$PMinRatio<-t$data.penaltyMinutes/t$data.gamesPlayed
avgPMins<-mean(t$PMinRatio)
t$WinCat<-NA
t$WinCat[t$WinRatio < avgWins] <- "Below Avg Wins"
t$WinCat[t$WinRatio >= avgWins] <- "At/Above Avg Wins"
t$PMinCat<-NA
t$PMinCat[t$PMinRatio < avgPMins] <- "Below Avg Penalty Mins"
t$PMinCat[t$PMinRatio >= avgPMins] <- "At/Above Avg Penalty Mins"
t1<-table(t$WinCat, t$PMinCat)
knitr::kable(t1, row.names=TRUE, caption = "Avg Wins vs Avg Penality Min")
```

```{r, echo=TRUE, message=FALSE}
g <- ggplot(t, aes(x=t$WinCat, y=t$data.homeWins)) + geom_boxplot()
g
g <- ggplot(t, aes(x=t$WinCat, y=t$data.homeLosses)) + geom_boxplot()
g
```
